<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HM Follow Up System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
        }
        
        .rtl {
            direction: rtl;
        }
        
        .ltr {
            direction: ltr;
        }
        
        .ticket-row:hover {
            background-color: #f3f4f6;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Language Selector -->
    <div class="fixed top-4 right-4 z-50">
        <button id="langToggle" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition">
            <i class="fas fa-language mr-2"></i> English
        </button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-blue-600 py-6 px-8 text-center">
                <h1 class="text-2xl font-bold text-white" data-i18n="welcome">مرحبًا بك في نظام متابعة التذاكر</h1>
                <p class="text-blue-100 mt-2" data-i18n="login_desc">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم</p>
            </div>
            <div class="p-8">
                <div class="mb-6">
                    <label for="username" class="block text-gray-700 font-medium mb-2" data-i18n="username">اسم المستخدم</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium mb-2" data-i18n="password">كلمة المرور</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                </div>
                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="remember" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="remember" class="ml-2 text-gray-700" data-i18n="remember">تذكرني</label>
                </div>
                <button id="loginBtn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    <span data-i18n="login">تسجيل الدخول</span>
                </button>
                <div id="loginError" class="mt-4 text-red-600 text-center hidden" data-i18n="login_error">اسم المستخدم أو كلمة المرور غير صحيحة</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-ticket-alt text-blue-600 text-2xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 ml-3" data-i18n="app_title">نظام متابعة التذاكر</h1>
                </div>
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center text-sm rounded-full focus:outline-none">
                            <span class="sr-only">Open user menu</span>
                            <span class="mr-2 text-gray-700 font-medium" id="currentUserName">عبدالله</span>
                            <div class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                                <i class="fas fa-user"></i>
                            </div>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-i18n="logout">تسجيل الخروج</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-3 mb-8">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                <i class="fas fa-ticket-alt text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate" data-i18n="total_tickets">إجمالي التذاكر</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900" id="totalTickets">0</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate" data-i18n="closed_tickets">التذاكر المغلقة</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900" id="closedTickets">0</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-red-500 rounded-md p-3">
                                <i class="fas fa-exclamation-circle text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate" data-i18n="open_tickets">التذاكر المفتوحة</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900" id="openTickets">0</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8 rtl:space-x-reverse">
                    <button id="createTab" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-i18n="create_ticket">إنشاء تذكرة جديدة</button>
                    <button id="searchTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-i18n="search_tickets">بحث عن التذاكر</button>
                    <button id="manageTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm admin-only hidden" data-i18n="manage_users">إدارة المستخدمين</button>
                </nav>
            </div>

            <!-- Create Ticket Form -->
            <div id="createTicketSection" class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6" data-i18n="new_ticket">تذكرة جديدة</h2>
                <form id="ticketForm">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3">
                        <div>
                            <label for="ticketNumber" class="block text-sm font-medium text-gray-700" data-i18n="ticket_number">رقم التذكرة</label>
                            <input type="text" id="ticketNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <div id="ticketNumberError" class="mt-1 text-sm text-red-600 hidden" data-i18n="ticket_exists">هذه التذكرة موجودة بالفعل</div>
                        </div>
                        <div>
                            <label for="accountName" class="block text-sm font-medium text-gray-700" data-i18n="account_name">اسم الحساب</label>
                            <input type="text" id="accountName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="platform" class="block text-sm font-medium text-gray-700" data-i18n="platform">المنصة</label>
                            <select id="platform" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="" selected disabled data-i18n="select_platform">اختر المنصة</option>
                                <option value="X" data-i18n="platform_x">منصة X</option>
                                <option value="Instagram" data-i18n="platform_instagram">إنستغرام</option>
                                <option value="Email" data-i18n="platform_email">البريد الإلكتروني</option>
                                <option value="Phone" data-i18n="platform_phone">مكالمة هاتفية</option>
                            </select>
                        </div>
                        <div>
                            <label for="openDate" class="block text-sm font-medium text-gray-700" data-i18n="open_date">تاريخ الفتح</label>
                            <input type="date" id="openDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="openTime" class="block text-sm font-medium text-gray-700" data-i18n="open_time">وقت الفتح</label>
                            <input type="time" id="openTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-gray-700" data-i18n="phone_number">رقم الجوال (اختياري)</label>
                            <input type="text" id="phoneNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-plus-circle mr-2"></i>
                            <span data-i18n="add_ticket">إضافة التذكرة</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Search Tickets Section -->
            <div id="searchTicketSection" class="hidden bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6" data-i18n="search_tickets">بحث عن التذاكر</h2>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 mb-6 admin-only hidden">
                    <div>
                        <label for="searchTicketNumber" class="block text-sm font-medium text-gray-700" data-i18n="ticket_number">رقم التذكرة</label>
                        <input type="text" id="searchTicketNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="searchAccountName" class="block text-sm font-medium text-gray-700" data-i18n="account_name">اسم الحساب</label>
                        <input type="text" id="searchAccountName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="searchPhoneNumber" class="block text-sm font-medium text-gray-700" data-i18n="phone_number">رقم الجوال</label>
                        <input type="text" id="searchPhoneNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-4 mb-6 admin-only hidden">
                    <div>
                        <label for="searchAgent" class="block text-sm font-medium text-gray-700" data-i18n="agent">الموظف</label>
                        <select id="searchAgent" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">الكل</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchStatus" class="block text-sm font-medium text-gray-700" data-i18n="status">الحالة</label>
                        <select id="searchStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">الكل</option>
                            <option value="open" data-i18n="open">مفتوحة</option>
                            <option value="closed" data-i18n="closed">مغلقة</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchFromDate" class="block text-sm font-medium text-gray-700" data-i18n="from_date">من تاريخ</label>
                        <input type="date" id="searchFromDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="searchToDate" class="block text-sm font-medium text-gray-700" data-i18n="to_date">إلى تاريخ</label>
                        <input type="date" id="searchToDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex space-x-4 rtl:space-x-reverse">
                    <button id="searchBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-search mr-2"></i>
                        <span data-i18n="search">بحث</span>
                    </button>
                    <button id="resetSearchBtn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-redo mr-2"></i>
                        <span data-i18n="reset">إعادة تعيين</span>
                    </button>
                    <button id="importBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 admin-only hidden">
                        <i class="fas fa-file-import mr-2"></i>
                        <span data-i18n="import_excel">استيراد من Excel</span>
                    </button>
                    <button id="exportBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 admin-only hidden">
                        <i class="fas fa-file-excel mr-2"></i>
                        <span data-i18n="export_excel">تصدير إلى Excel</span>
                    </button>
                </div>
                
                <div class="mt-6 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="serial">#</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="ticket_number">رقم التذكرة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="account_name">اسم الحساب</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="platform">المنصة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="open_date">تاريخ الفتح</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="open_time">وقت الفتح</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="close_time">وقت الإغلاق</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="6h_reminder">تذكير 6 ساعات</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="24h_reminder">تذكير 24 ساعة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="48h_reminder">تذكير 48 ساعة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="close_reason">سبب الإغلاق</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider admin-only hidden" data-i18n="agent">الموظف</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="actions">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Tickets will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="noTicketsFound" class="mt-6 text-center text-gray-500 hidden" data-i18n="no_tickets">لا توجد تذاكر مطابقة لبحثك</div>
            </div>

            <!-- Manage Users Section (Admin Only) -->
            <div id="manageUsersSection" class="hidden bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6" data-i18n="manage_users">إدارة المستخدمين</h2>
                
                <div class="mb-6">
                    <button id="addUserBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span data-i18n="add_user">إضافة مستخدم</span>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="username">اسم المستخدم</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="role">الدور</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="status">الحالة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="last_login">آخر تسجيل دخول</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="actions">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add User Modal -->
            <div id="addUserModal" class="hidden fixed inset-0 overflow-y-auto z-50">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" data-i18n="add_user">إضافة مستخدم</h3>
                            <div class="mb-4">
                                <label for="newUsername" class="block text-sm font-medium text-gray-700" data-i18n="username">اسم المستخدم</label>
                                <input type="text" id="newUsername" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="newPassword" class="block text-sm font-medium text-gray-700" data-i18n="password">كلمة المرور</label>
                                <input type="password" id="newPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-700" data-i18n="confirm_password">تأكيد كلمة المرور</label>
                                <input type="password" id="confirmPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="userRole" class="block text-sm font-medium text-gray-700" data-i18n="role">الدور</label>
                                <select id="userRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="agent" data-i18n="role_agent">موظف</option>
                                    <option value="admin" data-i18n="role_admin">مدير</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button id="saveUserBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="save">حفظ</span>
                            </button>
                            <button id="cancelAddUserBtn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Close Ticket Modal -->
            <div id="closeTicketModal" class="hidden fixed inset-0 overflow-y-auto z-50">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" data-i18n="close_ticket">إغلاق التذكرة</h3>
                            <div class="mb-4">
                                <label for="closeReason" class="block text-sm font-medium text-gray-700" data-i18n="close_reason">سبب الإغلاق</label>
                                <select id="closeReason" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="no_reminder" data-i18n="no_reminder">تم الإغلاق بدون تذكير</option>
                                    <option value="after_6h" data-i18n="after_6h">تم الإغلاق بعد التذكير الأول</option>
                                    <option value="after_24h" data-i18n="after_24h">تم الإغلاق بعد التذكير الثاني</option>
                                    <option value="after_48h" data-i18n="after_48h">تم الإغلاق بعد التذكير الثالث</option>
                                    <option value="no_response" data-i18n="no_response">تم الإغلاق لعدم الرد بعد التذكير الثالث</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="reminder6h" class="flex items-center">
                                    <input type="checkbox" id="reminder6h" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700" data-i18n="6h_reminder" title="${currentLang === 'ar' ? 'تذكير بعد 6 ساعات' : '6 hours reminder'}">تم التذكير بعد 6 ساعات</span>
                                </label>
                            </div>
                            <div class="mb-4">
                                <label for="reminder24h" class="flex items-center">
                                    <input type="checkbox" id="reminder24h" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700" data-i18n="24h_reminder">تم التذكير بعد 24 ساعة</span>
                                </label>
                            </div>
                            <div class="mb-4">
                                <label for="reminder48h" class="flex items-center">
                                    <input type="checkbox" id="reminder48h" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700" data-i18n="48h_reminder">تم التذكير بعد 48 ساعة</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button id="clearRemindersBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="clear_reminders">إلغاء التذكيرات</span>
                            </button>
                            <button id="saveRemindersBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="save_reminders">حفظ التذكيرات</span>
                            </button>
                            <button id="confirmCloseTicketBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="close_ticket">إغلاق التذكرة</span>
                            </button>
                            <button id="cancelCloseTicketBtn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                <span data-i18n="cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                welcome: "Welcome to HM Follow Up System",
                login_desc: "Please login to access the dashboard",
                username: "Username",
                password: "Password",
                remember: "Remember me",
                login: "Login",
                login_error: "Invalid username or password",
                app_title: "HM Follow Up System",
                logout: "Logout",
                total_tickets: "Total Tickets",
                closed_tickets: "Closed Tickets",
                open_tickets: "Open Tickets",
                create_ticket: "Create New Ticket",
                search_tickets: "Search Tickets",
                manage_users: "Manage Users",
                new_ticket: "New Ticket",
                ticket_number: "Ticket Number",
                account_name: "Account Name",
                platform: "Platform",
                platform_x: "Platform X",
                platform_instagram: "Instagram",
                platform_email: "Email",
                platform_phone: "Phone Call",
                open_date: "Open Date",
                open_time: "Open Time",
                phone_number: "Phone Number (Optional)",
                add_ticket: "Add Ticket",
                search: "Search",
                reset: "Reset",
                export_excel: "Export to Excel",
                serial: "#",
                open_date: "Open Date",
                close_time: "Close Time",
                "6h_reminder": "6h Reminder",
                "24h_reminder": "24h Reminder",
                "48h_reminder": "48h Reminder",
                close_reason: "Close Reason",
                agent: "Agent",
                actions: "Actions",
                no_tickets: "No tickets found matching your search",
                status: "Status",
                open: "Open",
                closed: "Closed",
                from_date: "From Date",
                to_date: "To Date",
                close_ticket: "Close Ticket",
                no_reminder: "Closed without reminder",
                after_6h: "Closed after first reminder",
                after_24h: "Closed after second reminder",
                after_48h: "Closed after third reminder",
                no_response: "Closed due to no response after third reminder",
                cancel: "Cancel",
                manage_users: "Manage Users",
                add_user: "Add User",
                role: "Role",
                last_login: "Last Login",
                role_agent: "Agent",
                role_admin: "Admin",
                save: "Save",
                confirm_password: "Confirm Password",
                select_platform: "Select Platform",
                save_reminders: "Save Reminders",
                import_excel: "Import from Excel",
                clear_reminders: "Clear Reminders"
            },
            ar: {
                select_platform: "اختر المنصة",
                welcome: "مرحبًا بك في نظام متابعة التذاكر",
                login_desc: "الرجاء تسجيل الدخول للوصول إلى لوحة التحكم",
                username: "اسم المستخدم",
                password: "كلمة المرور",
                remember: "تذكرني",
                login: "تسجيل الدخول",
                login_error: "اسم المستخدم أو كلمة المرور غير صحيحة",
                app_title: "نظام متابعة التذاكر",
                logout: "تسجيل الخروج",
                total_tickets: "إجمالي التذاكر",
                closed_tickets: "التذاكر المغلقة",
                open_tickets: "التذاكر المفتوحة",
                create_ticket: "إنشاء تذكرة جديدة",
                search_tickets: "بحث عن التذاكر",
                manage_users: "إدارة المستخدمين",
                new_ticket: "تذكرة جديدة",
                ticket_number: "رقم التذكرة",
                account_name: "اسم الحساب",
                platform: "المنصة",
                platform_x: "منصة X",
                platform_instagram: "إنستغرام",
                platform_email: "البريد الإلكتروني",
                platform_phone: "مكالمة هاتفية",
                open_date: "تاريخ الفتح",
                open_time: "وقت الفتح",
                phone_number: "رقم الجوال (اختياري)",
                add_ticket: "إضافة التذكرة",
                search: "بحث",
                reset: "إعادة تعيين",
                export_excel: "تصدير إلى Excel",
                serial: "#",
                open_date: "تاريخ الفتح",
                close_time: "وقت الإغلاق",
                "6h_reminder": "تذكير 6 ساعات",
                "24h_reminder": "تذكير 24 ساعة",
                "48h_reminder": "تذكير 48 ساعة",
                close_reason: "سبب الإغلاق",
                agent: "الموظف",
                actions: "إجراءات",
                no_tickets: "لا توجد تذاكر مطابقة لبحثك",
                status: "الحالة",
                open: "مفتوحة",
                closed: "مغلقة",
                from_date: "من تاريخ",
                to_date: "إلى تاريخ",
                close_ticket: "إغلاق التذكرة",
                no_reminder: "تم الإغلاق بدون تذكير",
                after_6h: "تم الإغلاق بعد التذكير الأول",
                after_24h: "تم الإغلاق بعد التذكير الثاني",
                after_48h: "تم الإغلاق بعد التذكير الثالث",
                no_response: "تم الإغلاق لعدم الرد بعد التذكير الثالث",
                cancel: "إلغاء",
                manage_users: "إدارة المستخدمين",
                add_user: "إضافة مستخدم",
                role: "الدور",
                last_login: "آخر تسجيل دخول",
                role_agent: "موظف",
                role_admin: "مدير",
                save: "حفظ",
                confirm_password: "تأكيد كلمة المرور",
                save_reminders: "حفظ التذكيرات"
            }
        };
        // Current language (default Arabic)
        let currentLang = 'ar';
        
        // Toggle language
        document.getElementById('langToggle').addEventListener('click', function() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            this.innerHTML = currentLang === 'ar' ? '<i class="fas fa-language mr-2"></i> English' : '<i class="fas fa-language mr-2"></i> العربية';
            translatePage();
        });
        // Translate the page
        function translatePage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = translations[currentLang][key] || key;
            });
        }
        // Sample data for tickets
        let tickets = [
            {
                id: 1,
                ticketNumber: "TKT-1001",
                accountName: "Ahmed Ali",
                platform: "Instagram",
                openDate: "2023-06-15",
                openTime: "10:30",
                closeTime: "",
                phoneNumber: "0555123456",
                reminder6h: false,
                reminder24h: false,
                reminder48h: false,
                closeReason: "",
                status: "open",
                agent: "Abdullah"
            },
            {
                id: 2,
                ticketNumber: "TKT-1002",
                accountName: "Mohammed Saleh",
                platform: "Email",
                openDate: "2023-06-14",
                openTime: "14:15",
                closeTime: "2023-06-15 09:45",
                phoneNumber: "0501234567",
                reminder6h: true,
                reminder24h: false,
                reminder48h: false,
                closeReason: "after_6h",
                status: "closed",
                agent: "Abdullah"
            }
        ];
        // Sample data for users
        let users = [
            {
                id: 1,
                username: "Abdullah",
                password: "A",
                role: "admin",
                status: "active",
                lastLogin: new Date().toISOString().split('T')[0]
            },
            {
                id: 2,
                username: "Admin",
                password: "Admin123",
                role: "admin",
                status: "active",
                lastLogin: new Date().toISOString().split('T')[0]
            },
            {
                id: 3,
                username: "Agent1",
                password: "Agent123",
                role: "agent",
                status: "active",
                lastLogin: new Date().toISOString().split('T')[0]
            }
        ];
        // Current user
        let currentUser = null;
        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Find user
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('currentUserName').textContent = user.username;
                
                // Set permissions based on role
                if (user.role === 'admin') {
                    // Show all admin features
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                    document.getElementById('manageTab').classList.remove('hidden');
                    document.getElementById('exportBtn').classList.remove('hidden');
                } else if (user.role === 'agent') {
                    // Hide admin features for agents
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                    document.getElementById('manageTab').classList.add('hidden');
                    document.getElementById('exportBtn').classList.add('hidden');
                    
                    // Show only create and search tabs
                    document.getElementById('createTab').click();
                }
                
                // Load tickets
                loadTickets();
                loadUsers();
                
                // Set today's date and current time as default
                const today = new Date();
                document.getElementById('openDate').valueAsDate = today;
                
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('openTime').value = `${hours}:${minutes}`;
                
                // Hide login error if shown
                document.getElementById('loginError').classList.add('hidden');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });
        // User menu toggle
        document.getElementById('userMenuBtn').addEventListener('click', function() {
            document.getElementById('userMenu').classList.toggle('hidden');
        });
        // Tab switching
        document.getElementById('createTab').addEventListener('click', function() {
            document.getElementById('createTicketSection').classList.remove('hidden');
            document.getElementById('searchTicketSection').classList.add('hidden');
            document.getElementById('manageUsersSection').classList.add('hidden');
            
            // Update tab styling
            this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            this.classList.add('border-blue-500', 'text-blue-600');
            
            document.getElementById('searchTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('searchTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            document.getElementById('manageTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('manageTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        document.getElementById('searchTab').addEventListener('click', function() {
            document.getElementById('createTicketSection').classList.add('hidden');
            document.getElementById('searchTicketSection').classList.remove('hidden');
            document.getElementById('manageUsersSection').classList.add('hidden');
            
            // Update tab styling
            this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            this.classList.add('border-blue-500', 'text-blue-600');
            
            document.getElementById('createTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('createTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            document.getElementById('manageTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('manageTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        document.getElementById('manageTab').addEventListener('click', function() {
            document.getElementById('createTicketSection').classList.add('hidden');
            document.getElementById('searchTicketSection').classList.add('hidden');
            document.getElementById('manageUsersSection').classList.remove('hidden');
            
            // Update tab styling
            this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            this.classList.add('border-blue-500', 'text-blue-600');
            
            document.getElementById('createTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('createTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            document.getElementById('searchTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('searchTab').classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        // Add new ticket
        document.getElementById('ticketForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ticketNumber = document.getElementById('ticketNumber').value;
            const accountName = document.getElementById('accountName').value;
            const platform = document.getElementById('platform').value;
            const openDate = document.getElementById('openDate').value;
            const openTime = document.getElementById('openTime').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            // Check if ticket number already exists
            if (tickets.some(t => t.ticketNumber === ticketNumber)) {
                document.getElementById('ticketNumberError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('ticketNumberError').classList.add('hidden');
            }
            
            // Create new ticket
            const newTicket = {
                id: tickets.length > 0 ? Math.max(...tickets.map(t => t.id)) + 1 : 1,
                ticketNumber,
                accountName,
                platform,
                openDate,
                openTime,
                closeTime: "",
                phoneNumber,
                reminder6h: false,
                reminder24h: false,
                reminder48h: false,
                closeReason: "",
                status: "open",
                agent: currentUser.username,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            tickets.push(newTicket);
            
            // Reset form
            this.reset();
            
            // Set today's date and current time as default
            const today = new Date();
            document.getElementById('openDate').valueAsDate = today;
            
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('openTime').value = `${hours}:${minutes}`;
            
            // Update ticket counts and table
            updateTicketCounts();
            loadTickets();
            
            // Show success message
            alert(currentLang === 'ar' ? 'تم إضافة التذكرة بنجاح' : 'Ticket added successfully');
        });
        // Load tickets into table
        function loadTickets(filteredTickets = null) {
            const tbody = document.getElementById('ticketsTableBody');
            tbody.innerHTML = '';
            
            const ticketsToDisplay = filteredTickets || tickets;
            
            if (ticketsToDisplay.length === 0) {
                document.getElementById('noTicketsFound').classList.remove('hidden');
                return;
            } else {
                document.getElementById('noTicketsFound').classList.add('hidden');
            }
            
            ticketsToDisplay.forEach((ticket, index) => {
                const row = document.createElement('tr');
                row.className = 'ticket-row';
                
                // Highlight open tickets
                if (ticket.status === 'open') {
                    row.classList.add('bg-yellow-50');
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.ticketNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.accountName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-i18n="platform_${ticket.platform.toLowerCase()}">${ticket.platform}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.openDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.openTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.closeTime || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.reminder6h ? '✅' : '❌'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.reminder24h ? '✅' : '❌'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ticket.reminder48h ? '✅' : '❌'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-i18n="${ticket.closeReason || 'open'}">${ticket.closeReason ? translations[currentLang][ticket.closeReason] || ticket.closeReason : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 admin-only hidden">${ticket.agent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${ticket.status === 'open' ? 
                            `<button class="text-blue-600 hover:text-blue-900 mr-2 close-ticket-btn" data-id="${ticket.id}" title="${currentLang === 'ar' ? 'إغلاق التذكرة' : 'Close Ticket'}">
                                <i class="fas fa-check-circle"></i> ${currentLang === 'ar' ? 'إغلاق' : 'Close'}
                            </button>` : 
                            `<span class="text-gray-500">${currentLang === 'ar' ? 'مغلقة' : 'Closed'}</span>`}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners to close ticket buttons
            document.querySelectorAll('.close-ticket-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticketId = parseInt(this.getAttribute('data-id'));
                    openCloseTicketModal(ticketId);
                });
            });
            
            // Update ticket counts
            updateTicketCounts();
            
            // Translate platform names and close reasons
            translatePage();
        }
        // Load users into table
        function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-i18n="role_${user.role}">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.lastLogin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${user.role !== 'admin' ? 
                            `<button class="text-red-600 hover:text-red-900 delete-user-btn" data-id="${user.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : 
                            ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    if (confirm(currentLang === 'ar' ? 'هل أنت متأكد من حذف هذا المستخدم؟' : 'Are you sure you want to delete this user?')) {
                        users = users.filter(u => u.id !== userId);
                        loadUsers();
                    }
                });
            });
            
            // Populate agent dropdown in search
            const agentDropdown = document.getElementById('searchAgent');
            agentDropdown.innerHTML = '<option value="">الكل</option>';
            users.filter(u => u.role === 'agent').forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                agentDropdown.appendChild(option);
            });
            
            // Translate roles
            translatePage();
        }
        // Update ticket counts
        function updateTicketCounts() {
            const total = tickets.length;
            const closed = tickets.filter(t => t.status === 'closed').length;
            const open = total - closed;
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('closedTickets').textContent = closed;
            document.getElementById('openTickets').textContent = open;
        }
        // Open close ticket modal
        function openCloseTicketModal(ticketId) {
            document.getElementById('closeTicketModal').classList.remove('hidden');
            
            // Set checkboxes based on current ticket reminders
            const ticket = tickets.find(t => t.id === ticketId);
            if (ticket) {
                document.getElementById('reminder6h').checked = ticket.reminder6h;
                document.getElementById('reminder24h').checked = ticket.reminder24h;
                document.getElementById('reminder48h').checked = ticket.reminder48h;
            }
            
            // Set confirm button data-id
            document.getElementById('confirmCloseTicketBtn').setAttribute('data-id', ticketId);
        }
        // Close ticket modal
        document.getElementById('cancelCloseTicketBtn').addEventListener('click', function() {
            document.getElementById('closeTicketModal').classList.add('hidden');
        });
        // Save reminders without closing
        document.getElementById('saveRemindersBtn').addEventListener('click', function() {
            const ticketId = parseInt(document.getElementById('confirmCloseTicketBtn').getAttribute('data-id'));
            const ticketIndex = tickets.findIndex(t => t.id === ticketId);
            
            if (ticketIndex !== -1) {
                // Once a reminder is checked, it cannot be unchecked unless ticket is closed
                const currentTicket = tickets[ticketIndex];
                const reminder6h = document.getElementById('reminder6h').checked;
                const reminder24h = document.getElementById('reminder24h').checked;
                const reminder48h = document.getElementById('reminder48h').checked;
                
                // Allow both setting and unsetting reminders
                currentTicket.reminder6h = reminder6h;
                currentTicket.reminder24h = reminder24h;
                currentTicket.reminder48h = reminder48h;
                
                // Close modal
                document.getElementById('closeTicketModal').classList.add('hidden');
                
                // Reload tickets
                loadTickets();
                
                // Show success message
                alert(currentLang === 'ar' ? 'تم حفظ التذكيرات بنجاح' : 'Reminders saved successfully');
            }
        });
        // Clear all reminders
        document.getElementById('clearRemindersBtn').addEventListener('click', function() {
            const ticketId = parseInt(document.getElementById('confirmCloseTicketBtn').getAttribute('data-id'));
            const ticketIndex = tickets.findIndex(t => t.id === ticketId);
            
            if (ticketIndex !== -1) {
                if (confirm(currentLang === 'ar' ? 'هل أنت متأكد من إلغاء جميع التذكيرات؟' : 'Are you sure you want to clear all reminders?')) {
                    tickets[ticketIndex].reminder6h = false;
                    tickets[ticketIndex].reminder24h = false;
                    tickets[ticketIndex].reminder48h = false;
                    
                    // Close modal
                    document.getElementById('closeTicketModal').classList.add('hidden');
                    
                    // Reload tickets
                    loadTickets();
                    
                    // Show success message
                    alert(currentLang === 'ar' ? 'تم إلغاء التذكيرات بنجاح' : 'Reminders cleared successfully');
                }
            }
        });
        // Confirm close ticket
        document.getElementById('confirmCloseTicketBtn').addEventListener('click', function() {
            const ticketId = parseInt(this.getAttribute('data-id'));
            const ticketIndex = tickets.findIndex(t => t.id === ticketId);
            
            if (ticketIndex !== -1) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const closeTime = `${hours}:${minutes}`;
                
                tickets[ticketIndex].closeTime = closeTime;
                tickets[ticketIndex].status = 'closed';
                tickets[ticketIndex].closeReason = document.getElementById('closeReason').value;
                tickets[ticketIndex].reminder6h = document.getElementById('reminder6h').checked;
                tickets[ticketIndex].reminder24h = document.getElementById('reminder24h').checked;
                tickets[ticketIndex].reminder48h = document.getElementById('reminder48h').checked;
                
                // Close modal
                document.getElementById('closeTicketModal').classList.add('hidden');
                
                // Reload tickets
                loadTickets();
                
                // Show success message
                alert(currentLang === 'ar' ? 'تم إغلاق التذكرة بنجاح' : 'Ticket closed successfully');
            }
        });
        // Search tickets
        document.getElementById('searchBtn').addEventListener('click', function() {
            const ticketNumber = document.getElementById('searchTicketNumber').value;
            const accountName = document.getElementById('searchAccountName').value;
            const phoneNumber = document.getElementById('searchPhoneNumber').value;
            const agent = document.getElementById('searchAgent').value;
            const status = document.getElementById('searchStatus').value;
            const fromDate = document.getElementById('searchFromDate').value;
            const toDate = document.getElementById('searchToDate').value;
            
            let filteredTickets = [...tickets];
            
            if (ticketNumber) {
                filteredTickets = filteredTickets.filter(t => t.ticketNumber.includes(ticketNumber));
            }
            
            if (accountName) {
                filteredTickets = filteredTickets.filter(t => t.accountName.includes(accountName));
            }
            
            if (phoneNumber) {
                filteredTickets = filteredTickets.filter(t => t.phoneNumber.includes(phoneNumber));
            }
            
            if (currentUser.role === 'admin') {
                if (agent) {
                    filteredTickets = filteredTickets.filter(t => t.agent === agent);
                }
                if (status) {
                    filteredTickets = filteredTickets.filter(t => t.status === status);
                }
                if (fromDate) {
                    filteredTickets = filteredTickets.filter(t => t.openDate >= fromDate);
                }
                if (toDate) {
                    filteredTickets = filteredTickets.filter(t => t.openDate <= toDate);
                }
            } else {
                // Agents can only see their own tickets
                filteredTickets = filteredTickets.filter(t => t.agent === currentUser.username);
                
                if (status) {
                    filteredTickets = filteredTickets.filter(t => t.status === status);
                }
            }
            
            if (status) {
                filteredTickets = filteredTickets.filter(t => t.status === status);
            }
            
            if (fromDate) {
                filteredTickets = filteredTickets.filter(t => t.openDate >= fromDate);
            }
            
            if (toDate) {
                filteredTickets = filteredTickets.filter(t => t.openDate <= toDate);
            }
            
            loadTickets(filteredTickets);
        });
        // Reset search
        document.getElementById('resetSearchBtn').addEventListener('click', function() {
            document.getElementById('searchTicketNumber').value = '';
            document.getElementById('searchAccountName').value = '';
            document.getElementById('searchPhoneNumber').value = '';
            document.getElementById('searchAgent').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchFromDate').value = '';
            document.getElementById('searchToDate').value = '';
            
            loadTickets();
        });
        // Export to Excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Prepare data for export
            const exportData = tickets.map(ticket => {
                return {
                    'Ticket Number': ticket.ticketNumber,
                    'Account Name': ticket.accountName,
                    'Platform': ticket.platform,
                    'Open Date': ticket.openDate,
                    'Open Time': ticket.openTime,
                    'Close Time': ticket.closeTime || '-',
                    '6h Reminder': ticket.reminder6h ? 'Yes' : 'No',
                    '24h Reminder': ticket.reminder24h ? 'Yes' : 'No',
                    '48h Reminder': ticket.reminder48h ? 'Yes' : 'No',
                    'Close Reason': ticket.closeReason ? translations[currentLang][ticket.closeReason] || ticket.closeReason : '-',
                    'Status': ticket.status === 'open' ? 'Open' : 'Closed',
                    'Agent': ticket.agent,
                    'Created By': ticket.createdBy,
                    'Created At': ticket.createdAt
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tickets");
            
            // Export to file
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Tickets_${date}.xlsx`);
        });
        // Add user modal
        document.getElementById('addUserBtn').addEventListener('click', function() {
            document.getElementById('addUserModal').classList.remove('hidden');
        });
        document.getElementById('cancelAddUserBtn').addEventListener('click', function() {
            document.getElementById('addUserModal').classList.add('hidden');
        });
        // Save new user
        document.getElementById('saveUserBtn').addEventListener('click', function() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!username || !password || !confirmPassword) {
                alert(currentLang === 'ar' ? 'الرجاء ملء جميع الحقول' : 'Please fill all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert(currentLang === 'ar' ? 'كلمة المرور غير متطابقة' : 'Passwords do not match');
                return;
            }
            
            if (users.some(u => u.username === username)) {
                alert(currentLang === 'ar' ? 'اسم المستخدم موجود بالفعل' : 'Username already exists');
                return;
            }
            
            const newUser = {
                id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                username,
                password,
                role,
                status: "active",
                lastLogin: new Date().toISOString().split('T')[0]
            };
            
            users.push(newUser);
            
            // Reset form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('userRole').value = 'agent';
            
            // Close modal
            document.getElementById('addUserModal').classList.add('hidden');
            
            // Reload users
            loadUsers();
            
            // Show success message
            alert(currentLang === 'ar' ? 'تم إضافة المستخدم بنجاح' : 'User added successfully');
        });
        // Bulk import tickets for admins
        document.getElementById('importBtn').addEventListener('click', function() {
            if (currentUser.role !== 'admin') return;
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx, .xls, .csv';
            
            fileInput.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    jsonData.forEach(item => {
                        if (!tickets.some(t => t.ticketNumber === item['Ticket Number'])) {
                            tickets.push({
                                id: tickets.length > 0 ? Math.max(...tickets.map(t => t.id)) + 1 : 1,
                                ticketNumber: item['Ticket Number'] || '',
                                accountName: item['Account Name'] || '',
                                platform: item['Platform'] || 'Email',
                                openDate: item['Open Date'] || new Date().toISOString().split('T')[0],
                                openTime: item['Open Time'] || '00:00',
                                closeTime: item['Close Time'] || '',
                                phoneNumber: item['Phone Number'] || '',
                                reminder6h: item['6h Reminder'] === 'Yes',
                                reminder24h: item['24h Reminder'] === 'Yes',
                                reminder48h: item['48h Reminder'] === 'Yes',
                                closeReason: item['Close Reason'] || '',
                                status: item['Status'] === 'Closed' ? 'closed' : 'open',
                                agent: item['Agent'] || currentUser.username,
                                createdBy: currentUser.username,
                                createdAt: new Date().toISOString()
                            });
                        }
                    });
                    
                    loadTickets();
                    updateTicketCounts();
                    alert(currentLang === 'ar' ? 'تم استيراد التذاكر بنجاح' : 'Tickets imported successfully');
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            fileInput.click();
        });
        // Initialize the app
        function init() {
            // Set today's date and current time as default
            const today = new Date();
            document.getElementById('openDate').valueAsDate = today;
            
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('openTime').value = `${hours}:${minutes}`;
            
            // Set default language to Arabic
            translatePage();
            
            // Auto-login for demo purposes (remove in production)
            document.getElementById('username').value = 'Abdullah';
            document.getElementById('password').value = 'A';
        }
        // Run initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
