<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HM Follow Up System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; }
    .ticket-row:hover { background-color: #f3f4f6; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-xl font-bold mb-4">تسجيل الدخول</h2>
      <input id="username" class="w-full mb-3 p-2 border rounded" placeholder="اسم المستخدم">
      <input id="password" type="password" class="w-full mb-3 p-2 border rounded" placeholder="كلمة المرور">
      <button id="loginBtn" class="w-full bg-blue-600 text-white p-2 rounded">دخول</button>
      <div id="loginError" class="text-red-600 text-center mt-2 hidden">بيانات الدخول غير صحيحة</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden p-6">

    <!-- Header -->
    <header class="flex justify-between mb-6">
      <h1 class="text-2xl font-bold">نظام متابعة التذاكر</h1>
      <div>
        <span id="currentUserName" class="mr-3"></span>
        <button id="logoutBtn" class="bg-gray-600 text-white px-3 py-1 rounded">خروج</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">إجمالي التذاكر</h3>
        <p id="totalTickets" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">التذاكر المغلقة</h3>
        <p id="closedTickets" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">التذاكر المفتوحة</h3>
        <p id="openTickets" class="text-2xl font-bold">0</p>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="flex space-x-4 rtl:space-x-reverse border-b mb-6">
      <button id="createTab" class="py-2 px-4 border-b-2 border-blue-600">إضافة تذكرة</button>
      <button id="searchTab" class="py-2 px-4">بحث التذاكر</button>
      <button id="manageTab" class="py-2 px-4 admin-only hidden">إدارة المستخدمين</button>
    </nav>

    <!-- Create Ticket -->
    <div id="createSection">
      <h2 class="text-lg font-bold mb-4">إضافة تذكرة جديدة</h2>
      <form id="ticketForm" class="space-y-3">
        <input id="ticketNumber" class="w-full p-2 border rounded" placeholder="رقم التذكرة">
        <input id="accountName" class="w-full p-2 border rounded" placeholder="اسم الحساب">
        <select id="platform" class="w-full p-2 border rounded">
          <option value="Instagram">Instagram</option>
          <option value="Email">Email</option>
          <option value="Phone">Phone</option>
        </select>
        <button class="bg-blue-600 text-white px-4 py-2 rounded">إضافة</button>
      </form>
    </div>

    <!-- Search Tickets -->
    <div id="searchSection" class="hidden">
      <h2 class="text-lg font-bold mb-4">قائمة التذاكر</h2>
      <div class="flex space-x-2 rtl:space-x-reverse mb-4">
        <button id="exportBtn" class="bg-green-600 text-white px-3 py-1 rounded admin-only hidden">تصدير</button>
        <button id="importBtn" class="bg-purple-600 text-white px-3 py-1 rounded admin-only hidden">استيراد</button>
        <button id="deleteAllBtn" class="bg-red-600 text-white px-3 py-1 rounded admin-only hidden">حذف جميع</button>
      </div>
      <table class="w-full border">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2">#</th>
            <th class="p-2">رقم التذكرة</th>
            <th class="p-2">اسم الحساب</th>
            <th class="p-2">المنصة</th>
            <th class="p-2">الحالة</th>
            <th class="p-2">إجراء</th>
          </tr>
        </thead>
        <tbody id="ticketsTableBody"></tbody>
      </table>
    </div>

    <!-- Manage Users -->
    <div id="manageSection" class="hidden">
      <h2 class="text-lg font-bold mb-4">إدارة المستخدمين</h2>
      <p>محتوى إدارة المستخدمين هنا...</p>
    </div>

  </div>

  <script>
    // بيانات تجريبية
    let users = [
      { username: "Admin", password: "123", role: "admin" },
      { username: "Agent1", password: "123", role: "agent" }
    ];
    let currentUser = null;
    let tickets = [
      { id: 1, ticketNumber: "TKT-1001", accountName: "Ahmed", platform: "Instagram", status: "open", agent:"Admin" },
      { id: 2, ticketNumber: "TKT-1002", accountName: "Mohammed", platform: "Email", status: "closed", agent:"Agent1" }
    ];

    // تسجيل الدخول
    document.getElementById("loginBtn").addEventListener("click", function() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const user = users.find(x => x.username === u && x.password === p);
      if (user) {
        currentUser = user;
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("currentUserName").textContent = user.username;
        applyPermissions();
        loadTickets();
        updateCounts();
        document.getElementById("loginError").classList.add("hidden");
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    });

    // خروج
    document.getElementById("logoutBtn").addEventListener("click", function() {
      currentUser = null;
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
    });

    // صلاحيات
    function applyPermissions() {
      if (currentUser.role === "admin") {
        document.querySelectorAll(".admin-only").forEach(el => el.classList.remove("hidden"));
      } else {
        document.querySelectorAll(".admin-only").forEach(el => el.classList.add("hidden"));
        document.getElementById("manageTab").classList.add("hidden");
        document.getElementById("exportBtn").classList.add("hidden");
        document.getElementById("importBtn").classList.add("hidden");
        document.getElementById("deleteAllBtn").classList.add("hidden");
        document.getElementById("createTab").click();
      }
    }

    // التبويبات
    document.getElementById("createTab").addEventListener("click", function() {
      document.getElementById("createSection").classList.remove("hidden");
      document.getElementById("searchSection").classList.add("hidden");
      document.getElementById("manageSection").classList.add("hidden");
    });
    document.getElementById("searchTab").addEventListener("click", function() {
      document.getElementById("createSection").classList.add("hidden");
      document.getElementById("searchSection").classList.remove("hidden");
      document.getElementById("manageSection").classList.add("hidden");
      loadTickets();
    });
    document.getElementById("manageTab").addEventListener("click", function() {
      document.getElementById("createSection").classList.add("hidden");
      document.getElementById("searchSection").classList.add("hidden");
      document.getElementById("manageSection").classList.remove("hidden");
    });

    // إضافة تذكرة
    document.getElementById("ticketForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const ticketNumber = document.getElementById("ticketNumber").value;
      const accountName = document.getElementById("accountName").value;
      const platform = document.getElementById("platform").value;
      tickets.push({ id: tickets.length+1, ticketNumber, accountName, platform, status:"open", agent: currentUser.username });
      this.reset();
      loadTickets();
      updateCounts();
      alert("تمت إضافة التذكرة");
    });

    // تحميل التذاكر
    function loadTickets(filteredTickets = null) {
      const tbody = document.getElementById("ticketsTableBody");
      tbody.innerHTML = "";
      let ticketsToShow = filteredTickets || tickets;
      if (currentUser.role === "agent") {
        ticketsToShow = ticketsToShow.filter(t => t.agent === currentUser.username);
      }
      ticketsToShow.forEach((t,i) => {
        const row = document.createElement("tr");
        row.className = "ticket-row";
        row.innerHTML = `
          <td class="p-2">${i+1}</td>
          <td class="p-2">${t.ticketNumber}</td>
          <td class="p-2">${t.accountName}</td>
          <td class="p-2">${t.platform}</td>
          <td class="p-2">${t.status==="open"?"مفتوحة":"مغلقة"}</td>
          <td class="p-2">
            ${currentUser.role==="admin"?`<button class="text-red-600 delete-ticket-btn" data-id="${t.id}">حذف</button>`:""}
          </td>
        `;
        tbody.appendChild(row);
      });
      updateCounts();
    }

    // تحديث الإحصائيات
    function updateCounts() {
      const total = tickets.length;
      const closed = tickets.filter(t=>t.status==="closed").length;
      const open = total-closed;
      document.getElementById("totalTickets").textContent = total;
      document.getElementById("closedTickets").textContent = closed;
      document.getElementById("openTickets").textContent = open;
    }

    // حذف تذكرة
    document.addEventListener("click", function(e){
      if(e.target.closest(".delete-ticket-btn")){
        const id = parseInt(e.target.getAttribute("data-id"));
        if(confirm("هل أنت متأكد من الحذف؟")){
          tickets = tickets.filter(t=>t.id!==id);
          loadTickets();
          updateCounts();
        }
      }
    });

    // حذف جميع التذاكر
    document.getElementById("deleteAllBtn").addEventListener("click", function(){
      if(confirm("حذف جميع التذاكر؟")){
        tickets = [];
        loadTickets();
        updateCounts();
      }
    });
  </script>
</body>
</html>
